# This GitHub action can publish assets for release when a tag is created.
# Currently its setup to run on any tag that matches the pattern "v*" (ie. v0.1.0).
#
# This uses an action (paultyng/ghaction-import-gpg) that assumes you set your
# private key in the `GPG_PRIVATE_KEY` secret and passphrase in the `PASSPHRASE`
# secret. If you would rather own your own GPG handling, please fork this action
# or use an alternative one for key handling.
#
# You will need to pass the `--batch` flag to `gpg` in your signing step
# in `goreleaser` to indicate this is being used in a non-interactive mode.
#
name: release
on:
  push:
    tags:
      - 'v*'

concurrency:
  # Allow only run per ref
  # Mitigate https://intuit.github.io/auto/docs/welcome/quick-merge
  group: ${{ github.workflow }}-${{ github.ref }}

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      -
        name: Checkout
        uses: actions/checkout@v6
      -
        name: Unshallow
        run: git fetch --prune --unshallow

      - uses: actions/setup-go@v6
        with:
          cache: true
          cache-dependency-path: 'go.sum'
          go-version-file: 'go.mod'
      # -
      #   name: Import GPG key
      #   id: import_gpg
      #   uses: crazy-max/ghaction-import-gpg@v6.1.0
      #   with:
      #     gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
      #     passphrase: ${{ secrets.PASSPHRASE }}
      -
        name: Run GoReleaser
        id: release
        uses: goreleaser/goreleaser-action@v6
        with:
          version: latest
          args: release --clean
        env:
          #GPG_FINGERPRINT: ${{ steps.import_gpg.outputs.fingerprint }}
          GITHUB_TOKEN: ${{ github.token }}

  publish-mirror:
    needs: goreleaser
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    env:
      NAMESPACE: 'cyrilgdn'
      PROVIDER_NAME: 'postgresql'
      REGISTRY: 'registry.terraform.io'
      MIRROR_DIR: 'mirror'
    steps:
      - name: Set VERSION from tag
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - uses: actions/checkout@v6

      - uses: actions/checkout@v6
        with:
          ref: gh-pages
          path: gh-pages

      - name: Download release artifacts
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Downloading artifacts for version ${VERSION}"
          MIRROR_VERSION_DIR="${{env.MIRROR_DIR}}/${{env.REGISTRY}}/${{env.NAMESPACE}}/${{env.PROVIDER_NAME}}/${{env.VERSION}}"

          # Create directory structure for network mirror
          mkdir -p "${MIRROR_VERSION_DIR}"

          # Download release assets
          gh release download "v${VERSION}" -D "${MIRROR_VERSION_DIR}"

      - name: Generate network mirror metadata
        run: |
          # Make script executable
          chmod +x scripts/generate-mirror-metadata.sh

          # Generate metadata
          ./scripts/generate-mirror-metadata.sh "${VERSION}" "${NAMESPACE}" "${PROVIDER_NAME}" "${MIRROR_DIR}/${REGISTRY}"

          # Update root simple index.html
          cp -f ./docs/mirror-index.html ${MIRROR_DIR}/index.html
          
          # Update gh-pages content
          cp -r ${MIRROR_DIR}/* ./gh-pages/

      - name: Commit and push to gh-pages
        run: |
          cd gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Release version ${VERSION}" || echo "No changes to commit"
          git push origin gh-pages

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./gh-pages

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
